Здравствуйте!

Понимаю, что вы впервые работаете с Argo CD, поэтому я подробно опишу каждый шаг установки и настройки. Я также учту, что ваш кластер Kubernetes работает на RedOS.

---

## **Что такое Argo CD?**

Argo CD — это инструмент для непрерывной доставки (Continuous Delivery) для Kubernetes, который использует подход GitOps. Это означает, что состояние вашего кластера определяется в Git-репозитории, и Argo CD автоматически синхронизирует кластер с этим состоянием.

---

## **Предварительные требования**

1. **Кластер Kubernetes**: Убедитесь, что ваш кластер Kubernetes настроен и работает.

2. **Доступ к кластеру**: У вас должен быть настроен `kubectl` и конфигурационный файл `kubeconfig` для доступа к кластеру.

3. **Интернет-соединение**: Требуется для загрузки необходимых компонентов.

---

## **Шаг 1: Установка Argo CD в кластер Kubernetes**

### **1.1. Создание пространства имен (namespace) для Argo CD**

Откройте терминал и выполните команду:

```bash
kubectl create namespace argocd
```

**Что делает эта команда?**

- `kubectl` — это командная утилита для взаимодействия с Kubernetes.
- `create namespace argocd` — создаёт новое пространство имен с названием `argocd`, где будут размещены все компоненты Argo CD.

### **1.2. Установка Argo CD в созданное пространство имен**

Выполните следующую команду:

```bash
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

**Объяснение:**

- `apply` — применяет манифесты Kubernetes из указанного файла.
- `-n argocd` — указывает, что установка происходит в пространстве имен `argocd`.
- `-f` — указывает на файл или URL с манифестами для установки.
- URL после `-f` — это ссылка на официальный манифест установки Argo CD.

**Что происходит:**

- Устанавливаются все необходимые компоненты Argo CD, включая сервер, контроллеры и UI.

---

## **Шаг 2: Установка Argo CD CLI на RedOS**

Argo CD CLI — это командная утилита для управления Argo CD.

### **2.1. Загрузка исполняемого файла**

Выполните команды:

```bash
sudo curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
```

**Объяснение:**

- `sudo` — выполняет команду с правами администратора.
- `curl` — утилита для загрузки файлов из интернета.
- `-sSL` — параметры для тихой загрузки и следования по редиректам.
- `-o /usr/local/bin/argocd` — сохраняет файл в указанном пути с именем `argocd`.

### **2.2. Установка прав исполнения**

Выполните:

```bash
sudo chmod +x /usr/local/bin/argocd
```

**Объяснение:**

- `chmod +x` — устанавливает права на исполнение для файла.

Теперь утилита `argocd` доступна для использования из терминала.

---

## **Шаг 3: Доступ к интерфейсу Argo CD**

По умолчанию Argo CD доступен только внутри кластера. Чтобы получить доступ к веб-интерфейсу с вашего компьютера, необходимо настроить порт-форвардинг.

### **3.1. Настройка порт-форвардинга**

Выполните команду:

```bash
kubectl port-forward svc/argocd-server -n argocd 8080:443
```

**Объяснение:**

- `port-forward` — перенаправляет локальный порт на порт сервиса внутри кластера.
- `svc/argocd-server` — указывает, что мы перенаправляем порт сервиса `argocd-server`.
- `-n argocd` — указывает пространство имен `argocd`.
- `8080:443` — перенаправляет локальный порт `8080` на порт `443` сервиса.

**Что происходит:**

- Теперь вы можете открыть браузер и перейти по адресу `https://localhost:8080`, чтобы получить доступ к веб-интерфейсу Argo CD.

**Важно:** Так как сервис использует самоподписанный сертификат, браузер может выдать предупреждение о безопасности. Вам нужно будет принять его, чтобы продолжить.

---

## **Шаг 4: Получение учетных данных администратора**

### **4.1. Получение пароля администратора**

По умолчанию логин — `admin`. Чтобы получить пароль, выполните команду:

```bash
kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath="{.data.password}" | base64 -d; echo
```

**Объяснение:**

- `get secret` — получает секрет с именем `argocd-initial-admin-secret`.
- `-o jsonpath="{.data.password}"` — извлекает поле `password` из секрета.
- `| base64 -d` — декодирует пароль из base64.
- `; echo` — добавляет перенос строки после вывода.

**Сохраните этот пароль**, он понадобится для входа в Argo CD.

---

Создать неймспейс


Создать секрет kubectl create secret docker-registry digit-dgepu-secret \
  -n digit \
  --docker-server=http://85.141.97.224:443 \
  --docker-username=admin \
  --docker-password=Metrolog1 \
  --docker-email=alekslesik@gmail.com
secret/digit-dgepu-secret created


## **Шаг 5: Настройка доступа Argo CD к вашему GitLab репозиторию**

Argo CD должен иметь доступ к вашему GitLab репозиторию, чтобы получать манифесты для развертывания.

### **5.1. Создание персонального токена доступа в GitLab**

1. **Войдите в ваш аккаунт GitLab**.

2. **Перейдите в настройки профиля**:

   - Нажмите на ваш аватар в правом верхнем углу.
   - Выберите «Settings» (Настройки).

3. **Создайте персональный токен доступа**:

   - В левой панели выберите «Access Tokens».
   - Введите имя токена, например, `argo-cd-token`.
   - Установите срок действия токена (опционально).
   - Установите флажок `read_api` и `read_repository`.
   - Нажмите «Create personal access token».

4. **Сохраните токен**, он понадобится для настройки Argo CD.

### **5.2. Добавление репозитория в Argo CD**

#### **Через CLI**

Выполните команду:

```bash
argocd login localhost:8080 --username admin --password ваш_пароль
```

**Объяснение:**

- `argocd login` — авторизует вас в Argo CD через CLI.
- `localhost:8080` — адрес сервера Argo CD (из-за порт-форвардинга).
- `--username` и `--password` — ваши учетные данные.

Добавьте репозиторий:

```bash
argocd repo add https://gitlab.com/your-username/your-repo.git \
  --username your-username \
  --password ваш_токен
```

**Обратите внимание:** Замените `your-username` на ваше имя пользователя GitLab, `your-repo.git` — на URL вашего репозитория, а `ваш_токен` — на персональный токен доступа.

#### **Через веб-интерфейс**

1. **Войдите в веб-интерфейс Argo CD** по адресу `https://localhost:8080`, используя логин `admin` и ваш пароль.

2. **Добавьте репозиторий**:

   - Перейдите в раздел «Settings» (значок шестерёнки в левом меню).
   - Выберите «Repositories».
   - Нажмите кнопку «Connect Repo».
   - Введите:
     - **Type**: Git
     - **Repository URL**: URL вашего репозитория GitLab.
     - **Username**: ваше имя пользователя GitLab.
     - **Password**: ваш персональный токен доступа.
   - Нажмите «Connect».

---

## **Шаг 6: Создание приложения в Argo CD**

Argo CD управляет приложениями, каждое из которых соответствует набору ресурсов Kubernetes, определённых в вашем репозитории.

### **6.1. Подготовка манифестов Kubernetes**

Убедитесь, что в вашем GitLab репозитории есть директория с манифестами Kubernetes (YAML-файлы), которые вы хотите развернуть. Это могут быть обычные манифесты, Helm charts или Kustomize.

### **6.2. Создание приложения через веб-интерфейс**

1. **Перейдите на главную страницу Argo CD** и нажмите «+ NEW APP».

2. **Заполните поля**:

   - **Application Name**: например, `my-app`.
   - **Project**: оставьте `default`, если не создавали других проектов.
   - **SYNC POLICY**: выберите `Manual` для ручной синхронизации или `Automatic` для автоматической.
   - **Repository URL**: выберите ваш репозиторий из выпадающего списка.
   - **Revision**: оставьте `HEAD` или укажите конкретную ветку, например, `main`.
   - **Path**: укажите путь к директории с манифестами внутри репозитория, например, `/manifests`.
   - **Cluster URL**: оставьте `https://kubernetes.default.svc`, что означает текущий кластер.
   - **Namespace**: укажите namespace, куда хотите развернуть приложение, например, `default`.

3. **Нажмите «CREATE»**.

### **6.3. Проверка и синхронизация приложения**

После создания приложения вы будете перенаправлены на страницу его состояния.

- **Sync Status**: показывает, синхронизировано ли состояние кластера с репозиторием.
- **Health Status**: показывает здоровье приложения (запущено ли оно корректно).

**Для ручной синхронизации** нажмите кнопку «SYNC» и подтвердите действие.

---

## **Шаг 7: Мониторинг и управление приложением**

### **7.1. Мониторинг через веб-интерфейс**

- Вы можете видеть графическое отображение ресурсов вашего приложения.
- Можно просматривать логи подов, события и детали каждого ресурса.

### **7.2. Управление через CLI**

Вы также можете использовать CLI для управления приложением.

**Получить информацию о приложении:**

```bash
argocd app get my-app
```

**Синхронизировать приложение:**

```bash
argocd app sync my-app
```

**Проверить статус приложения:**

```bash
argocd app status my-app
```

---

## **Дополнительные настройки**

### **8.1. Настройка вебхуков GitLab (опционально)**

Для автоматического запуска синхронизации при каждом изменении в репозитории вы можете настроить вебхуки.

1. **В Argo CD включите вебхуки**:

   - Перейдите в «Settings» -> «Webhooks».
   - Скопируйте URL для GitLab вебхуков.

2. **В GitLab настройте вебхук**:

   - Перейдите в настройки вашего репозитория GitLab.
   - Выберите «Webhooks».
   - Вставьте скопированный URL в поле «URL».
   - Выберите триггеры `Push events` и `Merge requests events`.
   - Нажмите «Add webhook».

### **8.2. Автоматическая синхронизация**

Если вы хотите, чтобы Argo CD автоматически синхронизировал изменения из репозитория без вебхуков:

- При создании или редактировании приложения установите в настройках **SYNC POLICY** значение `Automatic`.

### **8.3. Использование SSH для доступа к репозиторию (опционально)**

Если вы предпочитаете использовать SSH для доступа к приватному репозиторию:

1. **Создайте SSH-ключ**:

   ```bash
   ssh-keygen -t rsa -b 4096 -C "argo-cd" -f argo_cd_ssh_key
   ```

   Это создаст ключи `argo_cd_ssh_key` и `argo_cd_ssh_key.pub`.

2. **Добавьте публичный ключ в GitLab**:

   - В вашем репозитории GitLab перейдите в «Settings» -> «Repository» -> «Deploy Keys».
   - Нажмите «Add deploy key».
   - Вставьте содержимое `argo_cd_ssh_key.pub`.
   - Дайте ключу название и установите флажок `Write access` (если нужно).

3. **Добавьте приватный ключ в Argo CD**:

   - В веб-интерфейсе Argo CD перейдите в «Settings» -> «Repositories».
   - Нажмите «Connect Repo using SSH».
   - Введите SSH URL вашего репозитория, например, `git@gitlab.com:your-username/your-repo.git`.
   - Вставьте приватный ключ `argo_cd_ssh_key`.
   - Нажмите «Connect».

---

## **Полезные советы**

- **Документация**: Обращайтесь к [официальной документации Argo CD](https://argo-cd.readthedocs.io/en/stable/) для получения более подробной информации.

- **Обновление Argo CD**: Следите за обновлениями Argo CD и обновляйте его при необходимости.

- **Безопасность**: После первоначальной настройки рекомендуется изменить пароль администратора и настроить RBAC (контроль доступа на основе ролей).

---

## **Заключение**

Теперь у вас установлена и настроена система Argo CD, связанная с вашим GitLab репозиторием. Вы можете управлять развертыванием приложений в вашем кластере Kubernetes, используя подход GitOps.

Если у вас возникнут вопросы или потребуется помощь на каком-либо этапе, пожалуйста, дайте знать, и я подробно объясню или помогу решить проблему.